{% extends 'app/navigation.html' %}
{% load static %}
{% load humanize %}

{% block content %}

<div class="productpage">
    <div class="product_upper">
        <div class="searchbar">
            <form action="" method="GET">
                <input type="text" name="search" value="{{ search_query }}" placeholder="Search">
            </form>
        </div>
    </div>
    <div class="productbar">
        <div class="filterbar">
            <div class="filter_nav">
                <form action="" method="GET">
                    <input type="hidden" name="search" value="{{ search_query }}">
                    <input type="hidden" name="category" value="{{ category_filter }}">
                    <input type="hidden" name="brand_filter" value="{{ brand_filter }}">
                    <input type="hidden" name="component" value="{{ component_filter }}">
                    <select class="categoryitem" name="category" id="categorySelect">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                            <option value="{{ category.id }}" {% if category.id == request.GET.category %} selected {% endif %}>{{ category.category_name }}</option>
                        {% endfor %}
                    </select>
                    <select class="pricingitem" name="price_order" id="priceOrder">
                        <option value="high" {% if request.GET.price_order == 'high' %}selected{% endif %}>High Price</option>
                        <option value="low" {% if request.GET.price_order == 'low' %}selected{% endif %}>Lowest Price</option>
                    </select>
                </form>
            </div>
            <form id="brandDropdownForm" action="" method="GET" style="display:none;">
                <input type="hidden" name="category" value="{{ category_filter }}">
                <input type="hidden" name="price_order" value="{{ price_order }}">
                <select name="brand" id="brandDropdown">
                <option value="">Select Brand</option>
                {% for brand in brands %}
                    <option value="{{ brand.id }}" {% if brand_filter == brand.id|stringformat:'s' %}selected{% endif %}>{{ brand.brand|escape }}</option>
                {% endfor %}
                </select>
            </form>
            <div class="filtername">
                <form id="brandForm" action="" method="GET">
                    <input type="hidden" name="brand" id="brand_filter_input" value="{{ brand_filter }}">
                    <input type="hidden" name="category" value="{{ category_filter }}">
                    <input type="hidden" name="price_order" value="{{ price_order }}">
                    <ul id="brand_filter">
                        {% for brand in brands %}
                            <li data-id="{{ brand.id }}" class="brand-item {% if brand_filter == brand.id|stringformat:'s' %}selected{% endif %}">{{ brand.brand|escape }}</li>
                        {% endfor %}
                    </ul>
                </form>
                <ul id="component_filter_list" style="display:none;">
    <li data-id="cpu">CPU</li>
    <li data-id="gpu">GPU</li>
    <li data-id="ram">RAM / Memory</li>
    <li data-id="motherboard">Motherboard</li>
    <li data-id="storage">Storage</li>
    <li data-id="psu">Power Supply</li>
    <li data-id="case">PC Case</li>
    <li data-id="cooling">Cooling</li>
</ul>
            </div>
        </div>

        <section>
            <div class="box">
            {% if products %}
                {% for produkto in products %}
                    <div class="containerbox">
                        <button class="favorite_btn {% if produkto.id|stringformat:'s' in request.session.favorites %}favorited{% endif %}" data-product-id="{{ produkto.id }}" id="productfavorites"><img src="{% static 'images/icon/heart-black.png' %}" alt="" class="heart_favorite"></button>
                        <a href="{% url 'product_item' produkto.id %}" class="containerbox_a">
                        <div class="containerimage">
                            {% if produkto.image %}
                            <img src="{{ produkto.image.url }}" alt="">
                            {% endif %}
                        </div>
                        </a>
                        </a>
                        <div class="containercontent">
                            <p>{{ produkto.product_name }}</p>
                            <div class="containercart">
                                <h4>â‚±{{ produkto.price|intcomma }}</h4>
                                <div class="containercart_button">
                                    <form action="{% url 'direct_checkout' %}" method="POST">
                                    {% csrf_token %}
                                        <input type="hidden" name="product_id" value="{{ produkto.id }}">
                                        <button type="submit">Buy Now</button>
                                    </form>
                                    <button class="add-to-cart-btn" data-product-id="{{ produkto.id }}" type="button"><img src="{% static 'images/icon/cart.png' %}" alt="Cart"></button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
            </div>
        </section>
    </div>
</div>
<div id="cart-popup" class="cart-popup">
    <div class="cart-popup-content">
        <span class="cart-popup-message">Added to cart!</span>
    </div>
</div>


    <script src="https://cdn.botpress.cloud/webchat/v3.4/inject.js"></script>
    <script src="https://files.bpcontent.cloud/2025/11/05/07/20251105070326-3GYR6OU8.js" defer></script>
    <script>
        window.botpressWebChat.init({
        botId: '4b04a836-814b-48e0-a021-3f5e77b25de4',                        
        hostUrl: 'https://premorning-unadvantaged-melvin.ngrok-free.dev/',     
        enableQuickReplies: true,                     
        showConversationsButton: true,    
        })
    </script> 
        
    
    
<script>
    document.addEventListener('DOMContentLoaded', function () {
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        const cartButtons = document.querySelectorAll('.add-to-cart-btn');

        cartButtons.forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.preventDefault();

                const productId = this.dataset.productId;

                fetch(`/add-to-cart/${productId}`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ quantity: 1 })
                })
                .then(response => response.json())
                .then(data => {
                    alert('Product added to cart!');

                    const cartCountElement = document.getElementById('cart-count');
                    if (cartCountElement) {
                        cartCountElement.textContent = data.cart_count;
                    }

                    const popup = document.getElementById('cart-popup');
                    if (popup) {
                        popup.classList.add('show');
                        setTimeout(() => popup.classList.remove('show'), 2200);
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        });

        const categorySelect = document.getElementById("categorySelect");
        const priceSelect = document.getElementById("priceOrder");

        const brandList = document.getElementById("brand_filter");
        const componentList = document.getElementById("component_filter_list");

        const brandItems = document.querySelectorAll("#brand_filter li");
        const brandInput = document.getElementById("brand_filter_input");
        const brandForm = document.getElementById("brandForm");

        const COMPUTER_PARTS_CATEGORY_ID = "15";

        function updateSidebarFilter() {
            if (categorySelect.value === COMPUTER_PARTS_CATEGORY_ID) {
                brandList.style.display = "none";
                componentList.style.display = "block";
            }   
            else{
                brandList.style.display = "block";
                componentList.style.display = "none";
            }
        }
        updateSidebarFilter();

        categorySelect.addEventListener("change", function () {
            updateSidebarFilter();
            this.form.submit();
        });

    
        priceSelect.addEventListener("change", function () {
            this.form.submit();
        });


    
        brandItems.forEach(item => {
            item.addEventListener("click", function () {
                brandItems.forEach(i => i.classList.remove("selected"));
                this.classList.add("selected");

                brandInput.value = this.dataset.id;
                brandForm.submit();
            });
        });


    
        const componentItems = componentList.querySelectorAll("li");

        componentItems.forEach(item => {
            item.addEventListener("click", function () {

                componentItems.forEach(i => i.classList.remove("selected"));
                this.classList.add("selected");

                const params = new URLSearchParams(window.location.search);
                params.set("component", this.dataset.id);
                window.location.search = params.toString();
            });
        });

    });

</script>
    
{% endblock content %}
