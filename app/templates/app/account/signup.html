{% extends 'app/navigation.html' %}
{% load static %}
{% load socialaccount %}

{% block content %}

<script>
    function togglePasswordVisibility(button) {
        event.preventDefault();
        const wrapper = button.parentElement;
        const input = wrapper.querySelector('input[type="password"], input[type="text"]');
        const icon = button.querySelector('i');
        
        if (!input || !icon) return;
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {    
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }

    function startOTPCountdown() {
        const timerDisplay = document.getElementById('otp-timer');
        const verifyBtn = document.querySelector('button[type="submit"]');
        const otpInput = document.querySelector('input[name="otp_code"]');
        
        if (!timerDisplay) return;
        
        // Calculate expiration time (5 minutes from now)
        const endTime = new Date(new Date().getTime() + 5 * 60 * 1000);
        
        const countdown = setInterval(() => {
            const now = new Date().getTime();
            const distance = endTime - now;
            
            if (distance <= 0) {
                clearInterval(countdown);
                timerDisplay.innerHTML = '<span style="color: #c33; font-weight: bold;">OTP Expired - Redirecting to signup...</span>';
                if (verifyBtn) verifyBtn.disabled = true;
                if (verifyBtn) verifyBtn.style.opacity = '0.5';
                if (verifyBtn) verifyBtn.style.cursor = 'not-allowed';
                
                // Redirect to signup page after 2 seconds
                setTimeout(() => {
                    window.location.href = '{% url "register" %}';
                }, 2000);
                return;
            }
            
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            
            timerDisplay.innerHTML = `<span style="color: #666; font-weight: bold;">Time remaining: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}</span>`;
        }, 1000);
    }

    // Start countdown when OTP verification form is shown
    document.addEventListener('DOMContentLoaded', function() {
        const otpForm = document.querySelector('input[name="otp_code"]');
        if (otpForm) {
            startOTPCountdown();
        }
    });
</script>

<style>
    /* Hide global header/navigation and footer for the signup page */
    header, nav, .navbar, .site-header, .topbar, .main-nav, .navigation, .header, .site-navigation,
    footer, .site-footer, .page-footer, .footer, .footer-wrapper, .bottom-footer { display: none !important; }
    /* Home button */
    .signup-home-btn{ position: fixed; left: 14px; top: 14px; z-index: 1200; background: #fff; color:#222; padding:8px 12px; border-radius:8px; box-shadow: 0 6px 18px rgba(0,0,0,0.12); text-decoration:none; display:flex; align-items:center; gap:8px; font-weight:600 }
    .signuppage{ padding-top: 0; }
    
    /* Error message styling */
    .errorlist {position: absolute; list-style: none; padding: 0; margin: 0.5rem 0; }
    .errorlist li { background-color: #fee; color: #c33; padding: 0.6rem 0.8rem; border-radius: 0.4rem; border-left: 4px solid #c33; margin-bottom: 0.4rem; font-size: 0.9rem; line-height: 1.4; }
    
    .signup_leftbody small {position: absolute; display: block; width:20%; color: #c33; font-size: 0.85rem; margin-top: -1rem; z-index: 0;}
    
    /* Form field styling */
    .signup_leftbody div { margin-bottom: .5rem; }
    .signup_leftbody input, .signup_leftbody select { width: 100%; box-sizing: border-box; }
    .signup_leftbody input.form-control { border: 1px solid black; padding: 0.7rem; border-radius: 0.8rem; }
    
    /* Password visibility toggle */
    .password-input-wrapper { position: relative; margin-bottom: 0.5rem; }
    .password-input-wrapper input { padding-right: 40px; }
    .password-toggle-btn { position: absolute; width: 1rem !important; right: 12px; top: 50%; transform: translateY(-50%); background: none !important; border: none !important; cursor: pointer; color: #666 !important; font-size: 1.1rem !important; padding: .5px 1px !important; display: flex; align-items: center; justify-content: center; transition: color 0.2s; }
    .password-toggle-btn:active { color: #333; }
    
    @media (min-width: 768px){ .signup-home-btn{ left: 24px; top: 24px } }
    
    @media (max-width: 768px) {
        .signup-home-btn{ left: 10px; top: 10px; padding: 6px 10px; font-size: 0.85rem; }
        .errorlist li { font-size: 0.8rem; padding: 0.5rem 0.6rem; }
        .signup_leftbody small { font-size: 0.8rem; padding: 0.3rem 0.5rem; width: 50%;}
    }
    @media (max-width: 375px) {
        .signup_leftbody small{width: 80% !important; font-size: .6rem;}
    }
</style>

<a class="signup-home-btn" href="{% url 'product' %}"><i class="fa fa-home"></i> Home</a>

<div class="signuppage">
    <div class="signup_body">
        <div class="signup_left">
            <div class="signup_leftbody">
                <h2>Sign Up</h2>
                <form method="POST">
                    {% csrf_token %}
                        {% if otp_code %}
                        <h3 style="margin-bottom: .5rem;">Verify Your Email</h3>
                        <div id="otp-timer" style="margin-bottom: 1rem; font-size: 0.95rem;"></div>
                        <label for="otp_code">Enter OTP:</label>
                            <input class="verification_code" type="text" name="otp_code" required>
                            <input type="hidden" name="username" value="{{ form.instance.username }}">
                        <button type="submit">Verify OTP</button>
                        {% if not otp_code %}
                            <a href="{% url 'resend-otp' %}">Resend OTP</a>
                        {% endif %}
                        {% else %}
                        {% for field in form %}
                            {% if field.name == 'password1' or field.name == 'password2' %}
                                <div class="password-input-wrapper">
                                    {{ field }}
                                    <button type="button" class="password-toggle-btn" onclick="togglePasswordVisibility(this)">
                                        <i class="fa fa-eye"></i>
                                    </button>
                                </div>
                                {% if field.errors %}
                                    <small>
                                        {% for error in field.errors %}
                                            {{ error }}<br>
                                        {% endfor %}
                                    </small>
                                {% endif %}
                            {% else %}
                                <div>
                                    {{ field }}
                                    {% if field.errors %}
                                        <small>
                                            {% for error in field.errors %}
                                                {{ error }}<br>
                                            {% endfor %}
                                        </small>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    <button type="submit">Sign up</button>
                </form>
                <div class="signup_otheracc">
                    <p>or signup with</p>
                    <div class="signupacc_logo">
                        <a href="/accounts/google/login/?process=signup" class="google-signup-btn" title="Sign up with Google">
                            <img src="{% static 'images/icon/google-symbol.png' %}" alt="Google">
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="signup_right">
            <div class="signup_rightbody">
                <h4>Welcome Back!</h4>
                <div class="signupright_bodyp">
                    <p>Sign in to manage your appointments and device listings.</p>
                </div>
                <a href="{% url 'login' %}">Sign In</a>
            </div>
        </div>
    </div>
</div>

{% endblock content %}