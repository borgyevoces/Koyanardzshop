{% extends 'app/navigation.html' %}
{% load static %}

{% block content %}

<script type="module">
    import { firebaseSignupHandler } from "{% static 'js/firebase-signup.js' %}";
    
    window.firebaseSignupHandler = firebaseSignupHandler;

    function togglePasswordVisibility(button) {
        event.preventDefault();
        const input = button.previousElementSibling;
        const icon = button.querySelector('i');
        
        if (!input || !icon) return;
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {    
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }

    function togglePasswordField(img) {
        const wrapper = img.parentElement;
        const input = wrapper.querySelector('input');
        
        if (!input) return;
        
        if (input.type === 'password') {
            input.type = 'text';
            img.src = "{% static 'images/icon/password-visible.png' %}";
        } else {
            input.type = 'password';
            img.src = "{% static 'images/icon/password-hide.png' %}";
        }
    }

    function startOTPCountdown() {
        const timerDisplay = document.getElementById('otp-timer');
        const verifyBtn = document.querySelector('button[type="submit"]');
        const otpInput = document.querySelector('input[name="otp_code"]');
        
        if (!timerDisplay) return;
        
        // Calculate expiration time (5 minutes from now)
        const endTime = new Date(new Date().getTime() + 5 * 60 * 1000);
        
        const countdown = setInterval(() => {
            const now = new Date().getTime();
            const distance = endTime - now;
            
            if (distance <= 0) {
                clearInterval(countdown);
                timerDisplay.innerHTML = '<span style="color: #c33; font-weight: bold;">OTP Expired - Redirecting to signup...</span>';
                if (verifyBtn) verifyBtn.disabled = true;
                if (verifyBtn) verifyBtn.style.opacity = '0.5';
                if (verifyBtn) verifyBtn.style.cursor = 'not-allowed';
                
                // Redirect to signup page after 2 seconds
                setTimeout(() => {
                    window.location.href = '{% url "register" %}';
                }, 2000);
                return;
            }
            
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            
            timerDisplay.innerHTML = `<span style="color: #666; font-weight: bold;">Time remaining: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}</span>`;
        }, 1000);
    }

    async function handleFirebaseSignup(event) {
        event.preventDefault();
        
        const email = document.querySelector('input[name="email"]').value;
        const password1 = document.querySelector('input[name="password1"]').value;
        const password2 = document.querySelector('input[name="password2"]').value;
        const errorList = document.querySelector('.errorlist');
        
        // Validate passwords match
        if (password1 !== password2) {
            if (errorList) {
                errorList.innerHTML = '<li>Passwords do not match.</li>';
            }
            return;
        }

        // Show loading state
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Creating account...';

        try {
            const result = await firebaseSignupHandler.signup(email, password1);
            
            if (result.success) {
                // Clear errors
                if (errorList) errorList.innerHTML = '';
                
                // Show verification message
                const messageDiv = document.querySelector('.signup_leftbody');
                const verificationDiv = document.createElement('div');
                verificationDiv.style.cssText = 'background: #e8f5e9; border: 1px solid #4caf50; border-radius: 8px; padding: 1rem; margin: 1rem 0; color: #2e7d32;';
                verificationDiv.innerHTML = `
                    <h4 style="margin-top: 0;">Account Created!</h4>
                    <p>A verification email has been sent to <strong>${email}</strong></p>
                    <p>Please click the link in the email to verify your account before signing in.</p>
                    <p><small>Check your spam folder if you don't see the email.</small></p>
                `;
                messageDiv.appendChild(verificationDiv);
                
                // Reset form
                event.target.reset();
                
                // Redirect after 3 seconds
                setTimeout(() => {
                    window.location.href = '{% url "login" %}';
                }, 3000);
            } else {
                // Show error
                if (errorList) {
                    errorList.innerHTML = `<li>${result.message}</li>`;
                } else {
                    const newErrorList = document.createElement('ul');
                    newErrorList.className = 'errorlist';
                    newErrorList.innerHTML = `<li>${result.message}</li>`;
                    event.target.parentElement.insertBefore(newErrorList, event.target);
                }
            }
        } catch (error) {
            console.error('Signup error:', error);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    }

    window.handleFirebaseSignup = handleFirebaseSignup;
    window.togglePasswordVisibility = togglePasswordVisibility;

    // Start countdown when OTP verification form is shown
    document.addEventListener('DOMContentLoaded', function() {
        const otpForm = document.querySelector('input[name="otp_code"]');
        if (otpForm) {
            startOTPCountdown();
        }
    });
</script>

<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
        background: #f5f7fa !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    /* Hide global header/navigation and footer for the signup page */
    header, nav, .navbar, .site-header, .topbar, .main-nav, .navigation, .header, .site-navigation,
    footer, .site-footer, .page-footer, .footer, .footer-wrapper, .bottom-footer { display: none !important; }
    
    /* Home button */
    .signup-home-btn {
        position: fixed;
        left: 24px;
        top: 24px;
        z-index: 1200;
        background: #fff;
        color: #222;
        padding: 10px 16px;
        border-radius: 8px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.12);
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        font-size: 0.95rem;
        transition: all 0.3s ease;
    }
    
    .signup-home-btn:hover {
        box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }
    
    .signuppage {
        padding-top: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
    }
    
    .signup_body {
        display: flex;
        width: 90%;
        max-width: 1000px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.12);
        overflow: hidden;
        min-height: 750px !important;
    }
    
    .signup_left, .signup_right {
        flex: 1;
        padding: 48px 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 750px !important;
    }
    
    .signup_leftbody {
        width: 100%;
    }
    
    .signup_rightbody {
        width: 100%;
        text-align: center;
        color: white;
        padding: 40px 30px;
    }
    
    .signup_rightbody h4 {
        font-size: 1.8rem;
        margin-bottom: 20px;
        font-weight: 700;
        color: white;
    }
    
    .signupright_bodyp {
        margin-bottom: 30px;
    }
    
    .signupright_bodyp p {
        font-size: 1rem;
        line-height: 1.6;
        opacity: 1;
        color: white;
    }
    
    .signup_leftbody form {
        width: 100%;
    }
    
    .signup_leftbody form input {
        width: 100% !important;
        padding: 12px 40px 12px 16px !important;
        border: 1.5px solid #ddd !important;
        border-radius: 8px !important;
        font-size: 0.95rem !important;
        font-family: inherit !important;
        transition: all 0.3s ease !important;
        background: white !important;
        box-sizing: border-box !important;
    }
    
    .signup_leftbody form input:focus {
        outline: none !important;
        border-color: #003d99 !important;
        box-shadow: 0 0 0 3px rgba(0, 61, 153, 0.1) !important;
    }
    
    .signup_leftbody form input::placeholder {
        color: #999 !important;
    }
    
    .password-wrapper {
        position: relative;
        margin-bottom: 20px;
    }
    
    .password-wrapper input {
        width: 100%;
        padding: 12px 40px 12px 16px;
        border: 1.5px solid #ddd;
        border-radius: 8px;
        font-size: 0.95rem;
        font-family: inherit;
        transition: all 0.3s ease;
        background: white;
    }
    
    .password-wrapper input:focus {
        outline: none;
        border-color: #003d99;
        box-shadow: 0 0 0 3px rgba(0, 61, 153, 0.1);
    }
    
    .toggle-password {
        position: absolute;
        right: 14px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        width: 20px;
        height: 20px;
        opacity: 0.6;
        transition: opacity 0.2s;
    }
    
    .toggle-password:hover {
        opacity: 1;
    }
    
    .signup_leftbody label {
        display: block;
        margin-bottom: 8px;
        color: #555;
        font-weight: 500;
        font-size: 0.95rem;
    }
    
    .form_field {
        position: relative;
        margin-bottom: 20px;
    }
    
    .form_field input {
        width: 100%;
        padding: 12px 40px 12px 16px;
        border: 1.5px solid #ddd;
        border-radius: 8px;
        font-size: 0.95rem;
        font-family: inherit;
        transition: all 0.3s ease;
        background: white;
    }
    
    .form_field input:focus {
        outline: none;
        border-color: #003d99;
        box-shadow: 0 0 0 3px rgba(0, 61, 153, 0.1);
    }
    
    .form_field input::placeholder {
        color: #999;
    }
    
    .form_field i {
        position: absolute;
        right: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: #666;
        pointer-events: none;
        font-size: 1.1rem;
    }
    
    .password-input-wrapper {
        position: relative;
        margin-bottom: 20px;
    }
    
    .password-input-wrapper input {
        width: 100%;
        padding: 12px 40px 12px 16px;
        border: 1.5px solid #ddd;
        border-radius: 8px;
        font-size: 0.95rem;
        font-family: inherit;
        transition: all 0.3s ease;
    }
    
    .password-input-wrapper input:focus {
        outline: none;
        border-color: #003d99;
        box-shadow: 0 0 0 3px rgba(0, 61, 153, 0.1);
    }
    
    .password-toggle-btn {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: transparent !important;
        border: none !important;
        cursor: pointer;
        color: #666 !important;
        font-size: 1.1rem !important;
        padding: 4px 8px !important;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.2s;
    }
    
    .password-toggle-btn:hover {
        color: #003d99;
    }
    
    .password-toggle-btn i {
        pointer-events: none;
    }
    
    /* OTP Verification styling */
    #otp-timer {
        text-align: center;
        margin-bottom: 20px;
    }
    
    .verification_code {
        width: 100%;
        padding: 12px 16px;
        border: 1.5px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        letter-spacing: 8px;
        text-align: center;
        margin-bottom: 20px;
        font-family: 'Courier New', monospace;
        transition: all 0.3s ease;
    }
    
    .verification_code:focus {
        outline: none;
        border-color: #003d99;
        box-shadow: 0 0 0 3px rgba(0, 61, 153, 0.1);
    }
    
    /* Error message styling */
    .errorlist {
        list-style: none;
        padding: 0;
        margin: 0 0 20px 0;
    }
    
    .errorlist li {
        background-color: #fee;
        color: #c33;
        padding: 10px 14px;
        border-radius: 6px;
        border-left: 4px solid #c33;
        margin-bottom: 8px;
        font-size: 0.9rem;
        line-height: 1.5;
    }
    
    .signup_leftbody small {
        display: block;
        color: #c33;
        font-size: 0.85rem;
        margin-top: 6px;
        line-height: 1.4;
    }
    
    /* Button styling */
    button[type="submit"] {
        width: 100%;
        padding: 12px 24px;
        background: linear-gradient(135deg, #001a4d 0%, #003d99 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    button[type="submit"]:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 61, 153, 0.3);
    }
    
    button[type="submit"]:active {
        transform: translateY(0);
    }
    
    button[type="submit"]:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    /* Right side styling */
    .signup_rightbody h4 {
        font-size: 1.8rem;
        margin-bottom: 20px;
        font-weight: 700;
    }
    
    .signupright_bodyp {
        margin-bottom: 30px;
    }
    
    .signupright_bodyp p {
        font-size: 1rem;
        line-height: 1.6;
        opacity: 0.95;
    }
    
    .signup_rightbody a {
        display: inline-block;
        padding: 12px 40px;
        background: #003d99;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .signup_rightbody a:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 61, 153, 0.3);
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
        .signup-home-btn {
            left: 14px;
            top: 14px;
            padding: 8px 12px;
            font-size: 0.85rem;
        }
        
        .signup_body {
            flex-direction: column;
            width: 95%;
        }
        
        .signup_left, .signup_right {
            padding: 36px 24px;
            min-height: 650px;
        }
        
        .signup_leftbody h2 {
            font-size: 1.6rem;
            margin-bottom: 24px;
        }
        
        .signup_rightbody {
            padding: 30px 24px;
        }
        
        .signup_rightbody h4 {
            font-size: 1.4rem;
        }
        
        .form_field input, .password-input-wrapper input {
            padding: 11px 36px 11px 14px;
            font-size: 0.9rem;
        }
        
        .errorlist li {
            font-size: 0.8rem;
            padding: 8px 12px;
        }
        
        button[type="submit"] {
            padding: 11px 20px;
            font-size: 0.95rem;
        }
    }
    
    @media (max-width: 480px) {
        .signup-home-btn {
            left: 10px;
            top: 10px;
            padding: 6px 10px;
            font-size: 0.75rem;
        }
        
        .signup_left, .signup_right {
            padding: 24px 16px;
            min-height: auto;
        }
        
        .signup_leftbody h2 {
            font-size: 1.4rem;
            margin-bottom: 20px;
        }
        
        .signup_leftbody h3 {
            font-size: 1.2rem;
        }
        
        .form_field input, .password-input-wrapper input {
            padding: 10px 36px 10px 12px;
            font-size: 0.85rem;
        }
        
        .form_field {
            margin-bottom: 16px;
        }
        
        .signup_rightbody {
            padding: 24px 16px;
        }
        
        .signup_rightbody h4 {
            font-size: 1.2rem;
            margin-bottom: 16px;
        }
        
        .signupright_bodyp p {
            font-size: 0.9rem;
        }
        
        .signup_rightbody a {
            padding: 10px 32px;
            font-size: 0.85rem;
        }
    }
</style>

<a class="signup-home-btn" href="{% url 'product' %}"><i class="fa fa-home"></i> Home</a>

<div class="signuppage">
    <div class="signup_body">
        <div class="signup_left">
            <div class="signup_leftbody">
                <h2>Sign Up</h2>
                <form method="POST" onsubmit="handleFirebaseSignup(event)" id="firebase-signup-form">
                    {% csrf_token %}
                        {% if otp_code %}
                        <h3>Verify Your Email</h3>
                        <div id="otp-timer"></div>
                        <label for="otp_code">Enter OTP:</label>
                        <div class="form_field">
                            <input class="verification_code" type="text" name="otp_code" placeholder="000000" required>
                        </div>
                        <input type="hidden" name="username" value="{{ form.instance.username }}">
                        <button type="submit">Verify OTP</button>
                        {% if not otp_code %}
                            <a href="{% url 'resend-otp' %}">Resend OTP</a>
                        {% endif %}
                        {% else %}
                        <!-- Firebase Email Verification Status -->
                        <div id="firebase-verification-status" style="margin-bottom: 1rem; font-size: 0.95rem; text-align: center;"></div>
                        
                        {% for field in form %}
                            {% if field.name == 'email' %}
                                <div class="form_field">
                                    {{ field }}
                                    <i class="fa fa-envelope"></i>
                                    {% if field.errors %}
                                        <small>
                                            {% for error in field.errors %}
                                                {{ error }}<br>
                                            {% endfor %}
                                        </small>
                                    {% endif %}
                                </div>
                            {% elif field.name == 'username' %}
                                <div class="form_field">
                                    {{ field }}
                                    <i class="fa fa-user"></i>
                                    {% if field.errors %}
                                        <small>
                                            {% for error in field.errors %}
                                                {{ error }}<br>
                                            {% endfor %}
                                        </small>
                                    {% endif %}
                                </div>
                            {% elif field.name == 'password1' or field.name == 'password2' %}
                                <div class="password-wrapper">
                                    {{ field }}
                                    <img src="{% static 'images/icon/password-hide.png' %}" class="toggle-password" id="togglePassword{{ forloop.counter }}" alt="Show Password">
                                </div>
                                {% if field.errors %}
                                    <small>
                                        {% for error in field.errors %}
                                            {{ error }}<br>
                                        {% endfor %}
                                    </small>
                                {% endif %}
                            {% else %}
                                <div class="form_field">
                                    {{ field }}
                                    {% if field.errors %}
                                        <small>
                                            {% for error in field.errors %}
                                                {{ error }}<br>
                                            {% endfor %}
                                        </small>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    <button type="submit">Sign up</button>
                </form>
                <script>
                    // Handle password visibility toggle for all password fields
                    document.querySelectorAll('.toggle-password').forEach(toggle => {
                        toggle.addEventListener('click', function() {
                            const wrapper = this.parentElement;
                            const input = wrapper.querySelector('input');
                            if (input) {
                                if (input.type === 'password') {
                                    input.type = 'text';
                                    this.src = "{% static 'images/icon/password-visible.png' %}";
                                } else {
                                    input.type = 'password';
                                    this.src = "{% static 'images/icon/password-hide.png' %}";
                                }
                            }
                        });
                    });
                </script>
                {% endif %}
            </div>
        </div>
        <div class="signup_right">
            <div class="signup_rightbody">
                <h4>Welcome Back!</h4>
                <div class="signupright_bodyp">
                    <p>Sign in to manage your appointments and device listings.</p>
                </div>
                <a href="{% url 'login' %}">Sign In</a>
            </div>
        </div>
    </div>
</div>

{% endblock content %}