{% extends 'app/navigation.html' %}
{% load static %}
{% load humanize %}

{% block content %}
    <div class="sellingpage">
        <div class="selling_body">
            <div class="selling_left">
                <div class="selling_steps">
                    <div class="step-item" onclick="goToStep(1)">
                        <div class="step-circle" id="circle1">
                            <span class="step-check">✓</span>
                            <span class="step-number">1</span>
                        </div>
                        <p class="step-label">PERSONAL<br>INFORMATION</p>
                    </div>
                    <div class="step-line"></div>
                    <div class="step-item" onclick="goToStep(2)">
                        <div class="step-circle" id="circle2">
                            <span class="step-number">2</span>
                        </div>
                        <p class="step-label">PRODUCT<br>INFORMATION</p>
                    </div>
                    <div class="step-line"></div>
                    <div class="step-item" onclick="goToStep(3)">
                        <div class="step-circle" id="circle3">
                            <span class="step-number">3</span>
                        </div>
                        <p class="step-label">CONFIRMATION</p>
                    </div>
                </div>
            </div>
            <div class="selling_right">
                <form id="sellForm" method="POST" enctype="multipart/form-data" action="">
                    {% csrf_token %}

                    <!-- STEP 1 (was previous step2): Personal Information -->
                    <div id="step1" class="step-box step-active" style="display: block;">
                        <div class="sellingright_header">
                            <h2>Personal Information</h2>
                            <p>Enter your personal information to help us contact you and verify your identity. This will also be used to confirm your appointment schedule.</p>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>First Name:</label>
                                {{ form.first_name }}
                            </div>
                            <div class="form-group">
                                <label>Last Name:</label>
                                {{ form.last_name }}
                            </div>
                            <div class="form-group">
                                <label>Contact:</label>
                                {{ form.contact }}
                            </div>
                            <div class="form-group">
                                <label>Email:</label>
                                {{ form.email }}
                            </div>
                            <div class="form-group">
                                <label>Address:</label>
                                {{ form.address }}
                            </div>
                            <div class="form-group">
                                <label>Appointment Date:</label>
                                {{ form.selling_date }}
                            </div>
                            <div class="form-group">
                                <label>Appointment Time:</label>
                                {{ form.selling_time }}
                            </div>
                        </div>
                        <button type="button" class="button" id="buttton" onclick="nextStep(1)">Next</button>
                    </div>

                    <!-- STEP 2 (was previous step3): Product Information -->
                    <div id="step2" class="step-box" style="display: none;">
                        <div class="sellingright_header">
                            <h2>Product Information</h2>
                            <p>Provide the details of the device you wish to sell or trade in. Accurate specifications and clear images will help us assess your item faster.</p>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Product Name:</label>
                                {{ form.product_name }}
                            </div>
                            <div class="form-group">
                                {{ form.category.label_tag }} {{ form.category }}
                            </div>
                            <div class="form-group">
                                <label>Selling Price:</label>
                                {{ form.price }}
                            </div>
                            <div class="form-group">
                                <label>Product Image:</label>
                                {{ form.image }}
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 1rem;">
                            <label>Product Description:</label>
                             {{ form.description }}
                        </div>
                        <button type="button" class="button" onclick="nextStep(2)">Next</button>
                    </div>

                    <!-- STEP 3: Summary + Terms (was previous step1) -->
                    <div id="step3" class="step-box" style="display: none;">
                        <div class="sellingright_header">
                            <h2>Summary & Terms</h2>
                            <p>Review your submission below. Confirm the details and accept the terms to submit.</p>
                        </div>

                        <div id="summary_personal" class="step-summary">
                            <h3>Personal Information</h3>
                            <div id="summary_personal_content"></div>
                        </div>

                        <div id="summary_product" class="step-summary">
                            <h3>Product Information</h3>
                            <div id="summary_product_content"></div>
                        </div>

                        <!-- Summary only: show values from Step 1 & 2 -->
                        <div id="summary_image" style="margin:1rem 0">
                            <h4>Product Image Preview</h4>
                            <div id="summary_image_container"></div>
                        </div>

                        <div id="submit-error" style="color: red; margin-top: 10px; display: none;"></div>
                        <button type="button" class="button" onclick="submitForm()">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

<script>
    let highestStepReached = 1;

    function submitForm() {
        console.log("submitForm called");

        // Validate personal info (step1)
        const step1 = document.getElementById('step1');
        const step1Fields = step1.querySelectorAll("[required]");
        for (const field of step1Fields) {
            if (!field.value.trim()) {
                alert("Please fill in all required fields in Personal Information");
                goToStep(1);
                return;
            }
        }

        // Validate product info (step2)
        const step2 = document.getElementById('step2');
        const step2Fields = step2.querySelectorAll("[required]");
        for (const field of step2Fields) {
            if (!field.value.trim()) {
                alert("Please fill in all required fields in Product Information");
                goToStep(2);
                return;
            }
        }

        // All checks passed — submit the form
        document.getElementById('sellForm').submit();
    }

    function nextStep(current) {
        const currentStepRight = document.getElementById(`step${current}`);
        const errorMessages = currentStepRight.querySelectorAll(".error-message");
        errorMessages.forEach(msg => msg.remove());
        let isValid = true;
        const fields = currentStepRight.querySelectorAll("[required]");

        fields.forEach(field => {
            if (!field.value.trim()) {
                isValid = false;
                const errorMessage = document.createElement("div");
                errorMessage.classList.add("error-message");
                errorMessage.style.color = "red";
                errorMessage.textContent = `${field.placeholder || "This field"} is required`;
                field.parentElement.appendChild(errorMessage);
            }
        });

        if (!isValid) return;

        highestStepReached = Math.max(highestStepReached, current + 1);
        goToStep(current + 1);
        updateStepIndicators();
    }

    function goToStep(stepNumber) {
        if (stepNumber > highestStepReached) {
            return; 
        }

        document.querySelectorAll(".selling_right .step-box").forEach(step => {
            step.style.display = "none";
            step.classList.remove("step-active");
        });

        document.querySelector(`#step${stepNumber}`).style.display = "block";
        document.querySelector(`#step${stepNumber}`).classList.add("step-active");
        
        updateStepIndicators();
        // If user navigates to the confirmation step, populate the summary immediately
        if (stepNumber === 3) {
            populateSummary();
        }
    }

    function updateStepIndicators() {
        const stepItems = document.querySelectorAll('.step-item');
        const currentStep = document.querySelector('.selling_right .step-active');
        
        stepItems.forEach((item, index) => {
            const stepNum = index + 1;
            item.classList.remove('active', 'completed');
            
            if (stepNum < highestStepReached) {
                item.classList.add('completed');
            } else if (stepNum === highestStepReached) {
                item.classList.add('active');
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        updateStepIndicators();
        // populate summary when reaching step 3
        document.querySelectorAll('.step-item').forEach(item => item.addEventListener('click', function(){
            if (item.classList.contains('active') || item.classList.contains('completed')) {
                const idx = Array.from(document.querySelectorAll('.step-item')).indexOf(item) + 1;
                if (idx === 3) populateSummary();
            }
        }));
    });

    function populateSummary(){
        // Personal
        const personalFields = ['first_name','last_name','contact','email','address','selling_date','selling_time'];
        const personalContainer = document.getElementById('summary_personal_content');
        personalContainer.innerHTML = '';
        personalFields.forEach(name => {
            const el = document.querySelector(`[name="${name}"]`);
            if (el) {
                const p = document.createElement('p');
                p.textContent = `${el.name.replace('_',' ')}: ${el.value || '-'} `;
                personalContainer.appendChild(p);
            }
        });

        // Product
        const productFields = ['product_name','price','description'];
        const productContainer = document.getElementById('summary_product_content');
        productContainer.innerHTML = '';
        productFields.forEach(name => {
            const el = document.querySelector(`[name="${name}"]`);
            if (el) {
                const p = document.createElement('p');
                p.textContent = `${el.name.replace('_',' ')}: ${el.value || '-'} `;
                productContainer.appendChild(p);
            }
        });

        // Image preview
        const imageInput = document.querySelector('[name="image"]');
        const imageContainer = document.getElementById('summary_image_container');
        imageContainer.innerHTML = '';
        if (imageInput && imageInput.files && imageInput.files[0]) {
            const file = imageInput.files[0];
            const img = document.createElement('img');
            img.style.maxWidth = '240px';
            img.style.maxHeight = '240px';
            img.style.objectFit = 'cover';
            img.alt = 'Product image preview';
            img.src = URL.createObjectURL(file);
            imageContainer.appendChild(img);
        } else {
            imageContainer.textContent = 'No image selected';
        }
    }
</script>

{% endblock content %}