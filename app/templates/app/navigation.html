{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Koya Nardz Computer Trading{% endblock %}</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Afacad:ital,wght@0,400..700;1,400..700&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
    <script src="{% static 'js/base.js' %}?v=2.9"></script>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <!-- Three.js Libraries - Load from local static files (proven to work) -->
    <script>
        // Load THREE.js libraries sequentially from local static files
        // This ensures they load in correct order and are always available
        
        console.log('Starting THREE.js library loading...');
        
        function loadThreeLibraries() {
            // Load THREE.js first
            const threeScript = document.createElement('script');
            threeScript.src = '{% static "libs/three/three.min.js" %}';
            threeScript.onload = function() {
                console.log('✓ THREE.js loaded');
                loadGLTFLoader();
            };
            threeScript.onerror = function() {
                console.error('✗ Failed to load THREE.js from local static');
                // Fallback to CDN
                loadFromCDN();
            };
            document.head.appendChild(threeScript);
        }
        
        function loadGLTFLoader() {
            const gltfScript = document.createElement('script');
            gltfScript.src = '{% static "libs/three/GLTFLoader.js" %}';
            gltfScript.onload = function() {
                console.log('✓ GLTFLoader loaded');
                loadGLTFWrapper();
            };
            gltfScript.onerror = function() {
                console.error('✗ Failed to load GLTFLoader');
                loadOrbitControls();
            };
            document.head.appendChild(gltfScript);
        }
        
        function loadGLTFWrapper() {
            const wrapperScript = document.createElement('script');
            wrapperScript.src = '{% static "libs/three/GLTFLoader-wrapper.js" %}';
            wrapperScript.onload = function() {
                console.log('✓ GLTFLoader wrapper loaded');
                loadOrbitControls();
            };
            wrapperScript.onerror = function() {
                console.error('✗ Failed to load GLTFLoader wrapper');
                loadOrbitControls();
            };
            document.head.appendChild(wrapperScript);
        }
        
        function loadOrbitControls() {
            const orbitScript = document.createElement('script');
            orbitScript.src = '{% static "libs/three/OrbitControls.js" %}';
            orbitScript.onload = function() {
                console.log('✓ OrbitControls loaded');
                loadOrbitWrapper();
            };
            orbitScript.onerror = function() {
                console.error('✗ Failed to load OrbitControls');
                markThreeReady();
            };
            document.head.appendChild(orbitScript);
        }
        
        function loadOrbitWrapper() {
            const wrapperScript = document.createElement('script');
            wrapperScript.src = '{% static "libs/three/OrbitControls-wrapper.js" %}';
            wrapperScript.onload = function() {
                console.log('✓ OrbitControls wrapper loaded');
                markThreeReady();
            };
            wrapperScript.onerror = function() {
                console.error('✗ Failed to load OrbitControls wrapper');
                markThreeReady();
            };
            document.head.appendChild(wrapperScript);
        }
        
        function markThreeReady() {
            // Set global flags
            window.THREE_READY = true;
            console.log('✓ THREE.js ready');
            
            // Attach to THREE namespace if not already done
            if (typeof THREE !== 'undefined') {
                if (typeof GLTFLoader !== 'undefined' && !THREE.GLTFLoader) {
                    THREE.GLTFLoader = GLTFLoader;
                }
                if (typeof OrbitControls !== 'undefined' && !THREE.OrbitControls) {
                    THREE.OrbitControls = OrbitControls;
                }
            }
        }
        
        function loadFromCDN() {
            console.log('Loading THREE.js from CDN...');
            // Fallback to unpkg CDN
            const scripts = [
                { src: 'https://unpkg.com/three@r128/build/three.min.js', name: 'THREE.js' },
                { src: 'https://unpkg.com/three@r128/examples/js/loaders/GLTFLoader.js', name: 'GLTFLoader' },
                { src: 'https://unpkg.com/three@r128/examples/js/controls/OrbitControls.js', name: 'OrbitControls' }
            ];
            
            let loaded = 0;
            scripts.forEach((item) => {
                const script = document.createElement('script');
                script.src = item.src;
                script.async = true;
                script.onload = function() {
                    console.log('✓ CDN loaded:', item.name);
                    loaded++;
                    if (loaded === scripts.length) {
                        markThreeReady();
                    }
                };
                script.onerror = function() {
                    console.error('✗ CDN failed:', item.name);
                    loaded++;
                    if (loaded === scripts.length) {
                        markThreeReady();
                    }
                };
                document.head.appendChild(script);
            });
        }
        
        // Start loading when document is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadThreeLibraries);
        } else {
            loadThreeLibraries();
        }
    </script>
</head>
<body data-cart-count="{{ cart_count }}">

    <header class="site-header">
        <div class="header-inner container">
            <a class="brand-link" href="{% url 'home' %}">
                <img src="{% static 'images/LOGO.png' %}" alt="Koya Nardz" class="brand-logo">
                <div class="brand-text">
                    <span class="brand-title">Koya Nardz</span>
                    <small class="brand-sub">Computer Trading</small>
                </div>
            </a>

            <button class="nav-toggle" aria-label="Toggle navigation" aria-expanded="false">
                <span class="hamburger"></span>
            </button>

            <nav class="main-nav" aria-label="Primary navigation" style="text-transform: uppercase;">
                <ul class="nav-list" style="text-transform: uppercase;">
                    <li><a href="{% url 'product' %}"><span>Products</span></a></li>
                    <li class="has-sub">
                        <a href="{% url 'selling_information' %}"><span>Trade</span></a>
                    </li>
                    <li><a href="{% url 'my_appointment' %}"><span>Appointment</span></a></li>
                    <li class="nav-actions-mobile"><a href="{% url 'cart' %}"><i class="fa-solid fa-cart-shopping" aria-hidden="true"></i><span>Cart</span></a></li>
                    <li class="nav-actions-mobile"><button id="favToggleMobile" class="action-btn-mobile"><i class="fa-regular fa-heart" aria-hidden="true"></i><span>Favorites</span></button></li>
                    <li class="nav-actions-mobile">{% if user.is_authenticated %}<a href="{% url 'logout' %}" class="action-btn-mobile"><i class="fa-solid fa-right-from-bracket" aria-hidden="true"></i><span>Logout</span></a>{% else %}<a href="{% url 'login' %}" class="action-btn-mobile"><i class="fa-solid fa-right-to-bracket" aria-hidden="true"></i><span>Sign in</span></a>{% endif %}</li>
                </ul>
            </nav>

            <div class="header-actions">
                <a class="action-btn cart-btn" href="{% url 'cart' %}" title="Cart">
                    <i class="fa-solid fa-cart-shopping" aria-hidden="true"></i>
                    <span class="cart-badge" id="cartBadge" style="display: none;">0</span>
                </a>

                <div class="dropdown favorite-dropdown">
                    <button id="favToggle" class="action-btn" aria-haspopup="true" aria-expanded="false"><i class="fa-regular fa-heart" aria-hidden="true"></i></button>
                    <div id="favoriteDropdown" class="dropdown-panel">
                        {% if products_favorite %}
                            {% for produkto in products_favorite %}
                            <div class="fav-item" data-product-id="{{ produkto.id }}">
                                <div class="fav-left">
                                    <a href="{% url 'product_item' produkto.id %}"><img src="{{ produkto.image.url }}" alt="{{ produkto.product_name }}"></a>
                                    <div class="fav-meta">{{ produkto.product_name }}</div>
                                </div>
                                <div class="fav-actions">
                                    <button type="button" class="fav-remove-btn" data-product-id="{{ produkto.id }}" aria-label="Remove from favorites"><i class="fa-solid fa-trash-alt" aria-hidden="true"></i></button>
                                    <form action="{% url 'add_to_cart' produkto.id %}" method="POST">{% csrf_token %}<button type="submit" aria-label="Add to cart"><i class="fa-solid fa-shopping-cart" aria-hidden="true"></i></button></form>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="no-fav">No favorites yet</p>
                        {% endif %}
                    </div>
                </div>

                <div class="dropdown user-dropdown">
                    {% if user.is_authenticated %}
                        <button id="userToggle" class="action-btn user-btn">
                            <i class="fa-solid fa-user" aria-hidden="true"></i>
                        </button>
                        <div id="userDropdown" class="dropdown-panel user-dropdown-panel">
                            <div class="user-card">
                                {% if user.avatar %}
                                    <img src="{{ user.avatar.url }}" alt="{{ user.username }}" class="avatar-img-large">
                                {% else %}
                                    <i class="fa-solid fa-user-circle" aria-hidden="true" style="font-size: 2rem; color: #0b84c6;"></i>
                                {% endif %}
                                <div class="user-info" style="text-transform: capitalize;">{{ user.username }}</div>
                            </div>
                            <a href="{% url 'profile' %}"><i class="fa-solid fa-user-gear" aria-hidden="true"></i>Profile</a>
                            <a href="{% url 'logout' %}"><i class="fa-solid fa-right-from-bracket" aria-hidden="true"></i>Logout</a>
                        </div>
                    {% else %}
                        <a class="action-btn" href="{% url 'login' %}"><i class="fa-solid fa-right-to-bracket" aria-hidden="true"></i></a>
                    {% endif %}
                </div>
            </div>
        </div>
    </header>

    <main class="content-wrapper" style="background-color: whitesmoke;">{% block content %}{% endblock %}</main>

    <footer class="site-footer">
        <div class="footer-inner container">
            <div class="footer-col footer-about">
                <h4>About</h4>
                <p>Koya Nardz Computer Trading — trusted tech shop since 2016. New and secondhand laptops, desktops, and PC parts.</p>
                <div class="socials">
                    <a href="https://www.facebook.com/KOYANARDZGAMIN?log_join_id=94609efe-f6a2-435e-bff9-cbee4b2df289" class="social" aria-label="Facebook"><i class="fab fa-facebook-f" aria-hidden="true"></i></a>
                    <a href="instagram://user/?username=knctrading&igsh=MTBnZ2Z2eTdyemxzbw%3D%3D" class="social" aria-label="Instagram"><i class="fab fa-instagram" aria-hidden="true"></i></a>
                    <a href="#" class="social" aria-label="Twitter"><i class="fab fa-twitter" aria-hidden="true"></i></a>
                </div>
            </div>
            <div class="footer-col footer-links">
                <h4>Quick Links</h4>
                <ul>
                    <li><a href="{% url 'product' %}">Products</a></li>
                    <li><a href="{% url 'selling' %}">Sell</a></li>
                    <li><a href="{% url 'my_appointment' %}">Appointment</a></li>
                </ul>
            </div>
            <div class="footer-col footer-contact">
                <h4>Contact</h4>
                <p>Address: 342 Molino Rd. Bacoor, Cavite</p>
                <p>Email: koyanardzshop@gmail.com</p>
                <p>Contact: +63 916 541 1490 / +63 929 501 7109</p>
            </div>
        </div>
        <div class="footer-bottom">
            <div class="container">© {% now "Y" %} Koya Nardz — All rights reserved.</div>
        </div>
    </footer>

    <script>
        // Mobile nav toggle
        (function(){
            const toggle = document.querySelector('.nav-toggle');
            const nav = document.querySelector('.main-nav');
            toggle && toggle.addEventListener('click', function(){
                const expanded = this.getAttribute('aria-expanded') === 'true';
                this.setAttribute('aria-expanded', String(!expanded));
                nav.classList.toggle('open');
            });

            // Favorite dropdown / mobile redirect
            const favBtn = document.getElementById('favToggle');
            const favPanel = document.getElementById('favoriteDropdown');
            favBtn && favBtn.addEventListener('click', function(e){
                const isMobile = window.matchMedia('(max-width: 768px)').matches;
                if (isMobile) {
                    // On mobile, go to the favorites page instead of showing dropdown
                    window.location.href = "{% url 'favorite' %}";
                    return;
                }
                e.stopPropagation();
                const open = favPanel.style.display === 'block';
                favPanel.style.display = open ? 'none' : 'block';
            });

            // User dropdown toggle
            const userBtn = document.getElementById('userToggle');
            const userPanel = document.getElementById('userDropdown');
            userBtn && userBtn.addEventListener('click', function(e){
                e.stopPropagation();
                userPanel.style.display = userPanel.style.display === 'block' ? 'none' : 'block';
            });

            // Close dropdowns on outside click
            document.addEventListener('click', function(e){
                if(favPanel && !favPanel.contains(e.target) && e.target.id !== 'favToggle') favPanel.style.display = 'none';
                if(userPanel && !userPanel.contains(e.target) && e.target.id !== 'userToggle') userPanel.style.display = 'none';
            });

            // Mobile buttons that live inside the nav overlay
            const favBtnMobile = document.getElementById('favToggleMobile');
            const userBtnMobile = document.getElementById('userToggleMobile');
            favBtnMobile && favBtnMobile.addEventListener('click', function(e){
                e.stopPropagation();
                // On mobile, redirect to the favorites page
                window.location.href = "{% url 'favorite' %}";
            });
            userBtnMobile && userBtnMobile.addEventListener('click', function(e){
                e.stopPropagation();
                nav.classList.add('open');
                userPanel && (userPanel.style.display = userPanel.style.display === 'block' ? 'none' : 'block');
            });

            // Cart badge count
            function updateCartBadge() {
                const badge = document.getElementById('cartBadge');
                const cartCount = document.body.getAttribute('data-cart-count') || '0';
                const count = parseInt(cartCount);
                
                if (count > 0) {
                    badge.textContent = count > 99 ? '99+' : count;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }

            // Initialize cart badge on page load
            updateCartBadge();

            // Listen for cart updates (custom event)
            document.addEventListener('cartUpdated', updateCartBadge);
        })();
    </script>
</body>
</html>
            